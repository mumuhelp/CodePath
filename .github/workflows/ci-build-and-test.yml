name: CI - Build and Test

on:
  push:
    branches: [ "**" ]
  pull-request:
    branches: [ "**" ]

jobs:
  backend-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build all backend services
        run: |
          set -e
          mkdir -p jacoco-reports

          SERVICES=$(find backend -mindepth 1 -maxdepth 1 -type d -exec test -f '{}/pom.xml' \; -print)

          for SERVICE in $SERVICES; do
            SERVICE_NAME=$(basename "$SERVICE")
            echo "=============================="
            echo "Building backend service: $SERVICE_NAME"
            echo "=============================="

            mvn -f "$SERVICE/pom.xml" clean verify

            JACOCO_DIR="$SERVICE/target/site/jacoco"
            if [ -d "$JACOCO_DIR" ]; then
              echo "Copying JaCoCo report for $SERVICE_NAME"
              mkdir -p "jacoco-reports/$SERVICE_NAME"
              cp -r "$JACOCO_DIR"/* "jacoco-reports/$SERVICE_NAME/"
            else
              echo "No JaCoCo report found for $SERVICE_NAME"
            fi
          done
      
      - name: Upload JaCoCo reports
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-reports
          path: jacoco-reports


  frontend-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm install

      - name: Build frontend
        working-directory: frontend
        run: npm run build

  docker-images:
    runs-on: ubuntu-latest
    needs:
      - backend-build
      - frontend-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build backend images
        run: |
          SHA_TAG=${GITHUB_SHA::7}
          BACKEND_SERVICES=$(find backend -mindepth 1 -maxdepth 1 -type d -exec test -f '{}/Dockerfile' \; -print)

          for SERVICE in $BACKEND_SERVICES; do
            SERVICE_NAME=$(basename "$SERVICE")
            echo "Building backend service image: $SERVICE_NAME"

            docker build \
              --build-arg SERVICE_NAME=$SERVICE_NAME \
              -f backend/$SERVICE_NAME/Dockerfile .
          done

      - name: Build frontend image
        run: |
          SHA_TAG=${GITHUB_SHA::7}
          echo "Building frontend image"
          docker build -f ./frontend/Dockerfile frontend
